<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sweetwater Comments</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Order Comments</h1>

      <div class="nav-buttons">
        <button onclick="showCategory('all')" class="selected">All</button>
        <button onclick="showCategory('candy')">Candy</button>
        <button onclick="showCategory('call')">Call / Don't Call</button>
        <button onclick="showCategory('referred')">Who Referred Me</button>
        <button onclick="showCategory('signature')">Signature Requirements</button>
        <button onclick="showCategory('misc')">Miscellaneous</button>
        <button onclick="showCategory('review')">Review</button>
        <button onclick="updateAndReloadComments()">Update Comments</button>
      </div>
      <div class="sort-buttons">
        <button onclick="setSort('orderid')">Sort by Order ID</button>
        <button onclick="setSort('comments')">Sort by Comments</button>
        <button onclick="setSort('shipdate_expected')">Sort by Expected Ship Date</button>
      </div>

      <p class="highlight-explanation">
        Some comments are highlighted because the expected ship date is missing
        <br />and the comment references a specific date, day of the week, or month.
      </p>

      <div id="all" class="category-container active"></div>
      <div id="candy" class="category-container"></div>
      <div id="call" class="category-container"></div>
      <div id="referred" class="category-container"></div>
      <div id="signature" class="category-container"></div>
      <div id="misc" class="category-container"></div>
      <div id="review" class="category-container"></div>
    </div>

    <script>
      let commentsData = [];
      let currentSort = "orderid";

      function setSort(sortKey) {
        currentSort = sortKey;
        const selectedButton = document.querySelector(".nav-buttons .selected");
        const category = selectedButton ? selectedButton.getAttribute("onclick").match(/'([^']+)'/)[1] : "all";
        showCategory(category);
      }

      function sortComments(comments) {
        return comments.sort((a, b) => {
          if (currentSort === "orderid") {
            return Number(a.orderid) - Number(b.orderid);
          } else if (currentSort === "comments") {
            return a.comments.localeCompare(b.comments);
          } else if (currentSort === "shipdate_expected") {
            return (a.shipdate_expected || "").localeCompare(b.shipdate_expected || "");
          }
          return 0;
        });
      }

      function displayComments(comments, container) {
        container.innerHTML = "";
        const sortedComments = sortComments(comments);
        sortedComments.forEach((comment) => {
          const div = createCommentElement(comment);
          highlightCommentForReview(comment, div);
          container.appendChild(div);
        });
      }

      async function fetchComments() {
        try {
          const response = await fetch("http://localhost:8081/readComments.php");
          const data = await response.json();

          if (Array.isArray(data) && data.length > 0) {
            commentsData = data;
            showCategory("all");
          } else {
            document.getElementById("all").innerHTML = `<p class="no-comments">${data.message || "No comments available."}</p>`;
          }
        } catch (error) {
          console.error("Error fetching comments:", error);
          document.getElementById("all").innerHTML = "<p class='no-comments'>Error loading comments.</p>";
        }
      }

      function showCategory(category) {
        document.querySelectorAll(".category-container").forEach((categoryDiv) => {
          categoryDiv.classList.remove("active");
        });

        const selectedCategory = document.getElementById(category);
        selectedCategory.classList.add("active");

        const filteredComments = filterCommentsByCategory(category);
        displayComments(filteredComments, selectedCategory);

        document.querySelectorAll(".nav-buttons button").forEach((button) => {
          button.classList.remove("selected");
        });

        const selectedButton = document.querySelector(`.nav-buttons button[onclick="showCategory('${category}')"]`);
        if (selectedButton) selectedButton.classList.add("selected");
      }

      function filterCommentsByCategory(category) {
        if (category === "all") {
          return commentsData;
        } else if (category === "review") {
          return commentsData.filter((comment) => !comment.shipdate_expected);
        }
        return commentsData.filter((comment) => {
          switch (category) {
            case "candy":
              return comment.comments.toLowerCase().includes("candy");
            case "call":
              return comment.comments.toLowerCase().includes("call me") || comment.comments.toLowerCase().includes("don't call me");
            case "referred":
              return comment.comments.toLowerCase().includes("referred");
            case "signature":
              return comment.comments.toLowerCase().includes("signature");
            case "misc":
              return !["candy", "call", "referred", "signature"].some((keyword) => comment.comments.toLowerCase().includes(keyword));
            default:
              return false;
          }
        });
      }

      function isCommentHighlighted(comment) {
        const daysOfWeek = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
        const monthsOfYear = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
        const dateRegex = /\b(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\b/;
        const containsDayOfWeek = daysOfWeek.some((day) => comment.comments.toLowerCase().includes(day));
        const containsMonth = monthsOfYear.some((month) => comment.comments.toLowerCase().includes(month));
        const containsDate = dateRegex.test(comment.comments);
        const containsMonthWord = /\bmonth\b|\bmonths\b/.test(comment.comments.toLowerCase());
        return !comment.shipdate_expected && (containsDayOfWeek || (containsMonth && !containsMonthWord) || containsDate);
      }

      function createCommentElement(comment) {
        const div = document.createElement("div");
        div.classList.add("comment");
        div.innerHTML = `
          <strong>Order ID:</strong> ${comment.orderid}<br>
          <strong>Comments:</strong> ${comment.comments}<br>
          <strong>Expected Ship Date:</strong> 
          <span>${comment.shipdate_expected ? comment.shipdate_expected : "N/A"}</span>
        `;
        return div;
      }

      function highlightCommentForReview(comment, div) {
        if (isCommentHighlighted(comment)) {
          div.classList.add("highlight");
        }
      }

      async function updateAndReloadComments() {
        try {
          const updateResponse = await fetch("http://localhost:8081/updateCommentsInBatchProcess.php", {
            method: "POST",
          });
          const updateResult = await updateResponse.text();
          console.log("Update response:", updateResult);
          await fetchComments();
        } catch (error) {
          console.error("Error updating comments:", error);
        }
      }

      window.onload = fetchComments;
    </script>
  </body>
</html>
