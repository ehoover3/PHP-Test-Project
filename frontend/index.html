<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sweetwater Comments</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Order Comments</h1>

      <div class="nav-buttons">
        <button onclick="showCategory('all')">All</button>
        <button onclick="showCategory('candy')">Candy</button>
        <button onclick="showCategory('call')">Call Me / Don't Call Me</button>
        <button onclick="showCategory('referred')">Who Referred Me</button>
        <button onclick="showCategory('signature')">Signature Requirements</button>
        <button onclick="showCategory('misc')">Miscellaneous</button>
        <button onclick="showCategory('review')">Review</button>
        <button onclick="updateAndReloadComments()">Update Comments</button>
      </div>

      <p class="highlight-explanation">Some comments are highlighted because the expected ship date is missing <br />and the comment references a specific date, day of the week, or month.</p>

      <div id="all" class="category-container"></div>
      <div id="candy" class="category-container"></div>
      <div id="call" class="category-container"></div>
      <div id="referred" class="category-container"></div>
      <div id="signature" class="category-container"></div>
      <div id="misc" class="category-container"></div>
      <div id="review" class="category-container"></div>
    </div>

    <script>
      let commentsData = [];

      async function fetchComments() {
        try {
          const response = await fetch("http://localhost:8081/readComments.php");
          const data = await response.json();

          if (Array.isArray(data) && data.length > 0) {
            commentsData = data;
            showCategory("all");
          } else {
            document.getElementById("all").innerHTML = `<p class="no-comments">${data.message || "No comments available."}</p>`;
          }
        } catch (error) {
          console.error("Error fetching comments:", error);
          document.getElementById("all").innerHTML = "<p class='no-comments'>Error loading comments.</p>";
        }
      }

      function showCategory(category) {
        const categories = document.querySelectorAll(".category-container");
        categories.forEach((categoryDiv) => {
          categoryDiv.classList.remove("active");
        });

        const selectedCategory = document.getElementById(category);
        selectedCategory.classList.add("active");

        const filteredComments = filterCommentsByCategory(category);
        displayComments(filteredComments, selectedCategory);

        const buttons = document.querySelectorAll(".nav-buttons button");
        buttons.forEach((button) => {
          button.classList.remove("selected");
        });
        const selectedButton = document.querySelector(`.nav-buttons button[onclick="showCategory('${category}')"]`);
        selectedButton.classList.add("selected");
      }

      function filterCommentsByCategory(category) {
        if (category === "all") {
          return commentsData;
        } else if (category === "review") {
          return commentsData.filter((comment) => !comment.shipdate_expected);
        }
        return commentsData.filter((comment) => {
          switch (category) {
            case "candy":
              return comment.comments.toLowerCase().includes("candy");
            case "call":
              return comment.comments.toLowerCase().includes("call me") || comment.comments.toLowerCase().includes("don't call me");
            case "referred":
              return comment.comments.toLowerCase().includes("referred");
            case "signature":
              return comment.comments.toLowerCase().includes("signature");
            case "misc":
              return !["candy", "call", "referred", "signature"].some((keyword) => comment.comments.toLowerCase().includes(keyword));
            default:
              return false;
          }
        });
      }

      function displayComments(comments, container) {
        container.innerHTML = "";
        if (comments.length > 0) {
          const sortedComments = comments.sort((a, b) => {
            const isHighlightedA = isCommentHighlighted(a);
            const isHighlightedB = isCommentHighlighted(b);
            return isHighlightedB - isHighlightedA;
          });

          sortedComments.forEach((comment) => {
            const div = createCommentElement(comment);
            highlightCommentForReview(comment, div);
            container.appendChild(div);
          });
        } else {
          container.innerHTML = "<p class='no-comments'>No comments available for this category.</p>";
        }
      }

      function isCommentHighlighted(comment) {
        const daysOfWeek = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
        const monthsOfYear = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
        const dateRegex = /\b(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\b/;

        const containsDayOfWeek = daysOfWeek.some((day) => comment.comments.toLowerCase().includes(day));
        const containsMonth = monthsOfYear.some((month) => comment.comments.toLowerCase().includes(month));
        const containsDate = dateRegex.test(comment.comments);

        const containsMonthWord = /\bmonth\b|\bmonths\b/.test(comment.comments.toLowerCase());
        const containsSpecificMonth = monthsOfYear.some((month) => comment.comments.toLowerCase().includes(month));

        return !comment.shipdate_expected && (containsDayOfWeek || (containsSpecificMonth && !containsMonthWord) || containsDate);
      }

      function createCommentElement(comment) {
        const div = document.createElement("div");
        div.classList.add("comment");
        div.innerHTML = `
          <strong>Order ID:</strong> ${comment.orderid}<br>
          <strong>Comments:</strong> ${comment.comments}<br>
          <strong>Expected Ship Date:</strong> 
          <span>${comment.shipdate_expected ? comment.shipdate_expected : "N/A"}</span>
        `;
        return div;
      }

      function highlightCommentForReview(comment, div) {
        if (isCommentHighlighted(comment)) {
          div.classList.add("highlight");
        }
      }

      async function updateAndReloadComments() {
        try {
          const updateResponse = await fetch("http://localhost:8081/updateCommentsInBatchProcess.php", {
            method: "POST",
          });
          const updateResult = await updateResponse.text();
          console.log("Update response:", updateResult);
          await fetchComments();
        } catch (error) {
          console.error("Error updating comments:", error);
        }
      }

      window.onload = fetchComments;
    </script>
  </body>
</html>
